## 0.网络有用资料

链接：https://www.anquanke.com/post/id/258874
链接：https://space.bilibili.com/476114390/search/video?keyword=Linux

## 1.第一个驱动程序

### 驱动的简易流程
    
- 1.确定major，0表示自动分配
- 2.实例化一个file_operations结构体
- 3.实现open/write/read等函数，链接到以上结构体
- 4.在(__init修饰)入口函数内注册字符设备register_chrdev，
    例如 register_chrdev(0, "hello", &hello_ops); 完成注册后将在/prop/devices看到字符设备/hello
    被__init修饰的入口函数代码会存入.init.text段，
    表示该代码仅仅在初始化期间使用，在模块装载后，该代码内存将被释放
- 5.在(__exit修饰)出口函数内注销字符设备unregister_chrdev，
    被__exit修饰的出口函数代码会存入.exit.text段，
- 6.添加module_init、modile_exit    
    例：在module_init(hello_init)和module_exit(hello_exit)中，
    如果定义了MODULE，相当于静态加载进内核，
    相当于定义一个存放在.initcall6.init代码段的_initcall_hello_init6的函数指针变量，并指向hello_init
    linux在do_initcalls函数中遍历initcalls段中每一个函数指针，然后顺序执行函数
    没有定义MODULE，相当于动态加载进内核，
    会生成 文件名.ko 文件 ，通过insmod加载进入内核，通过rmmod卸载
    可以不使用module_init和module_exit宏，而是直接定义init_moudle和cleanup_module
    -   https://blog.csdn.net/OnlyLove_/article/details/121641335
- 7.添加其他信息 MODULE_LICENSE("GPL");MODULE_AUTHOR("");MODULE_DESCRIPTION("");

### 驱动程序的udev

- 1.实例化一个class结构体
- 2.
    6.实例化一个class结构体
    7.在入口函数中创建类class_create，然后紧接着创建设备节点device_create
    8.在出口函数中销毁设备节点device_destroy，然后紧接着销毁类class_destroy,最后才是销毁字符设备

### 驱动程序的数据流向

- 1.读数据用 copy_to_user   将驱动数据复制给用户
- 2.写数据用 copy_from_user 将用户数据复制个驱动

### 实际操作

- 1.在ubuntu18中

    apt-cache search linux-headers-$(uname -r)       
// 确认有没有liunx的头文件 如linux-headers-5.4.0-94-generic
    sudo apt-get install linux-headers-$(uname -r)	 
// 下载安装

- 2.复制05_transfer_data文件夹下的代码到ubuntu中，
    make编译代码，生成了.ko文件
    执行sudo insmod hello_drv.ko 动态装载驱动
    执行cat /proc/devices 看字符设备是否挂上
    dmesg查看内核打印信息
    lsmod显示装载的模块信息
    sudo rmmod hello_drv卸载模块

    hello_drv_test.c是应用程序
    使用gcc -o hello_drv_test hello_drv_test.c 
    执行cat /proc/devices 看字符设备节点为240
    执行sudo mknod /dev/xyz c 240 0 创建指定的文件
        设备节点的名称可以自己取比方说xyz
    执行 ls -l /dev/xyz 查看文件的详细信息，
        显示crw-r--r-- 1 root root 240, 0 Mar 15 11:47 /dev/xy
        c表示字符文件,r可读w可写 1表示占用1块内存块


---------- `asfd` ---------- ----------
**asd**

- 1
  - 1.1
  - 1.2
  - 1.3




    